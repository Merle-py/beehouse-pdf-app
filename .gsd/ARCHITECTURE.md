# Architecture

> Generated by /map on 2026-01-19

## Overview

BeeHouse PDF App is a **Next.js 14 App Router** real estate sales authorization management system. It enables real estate brokers to create and manage sales authorizations (Autorizações de Venda) for properties (Imóveis) owned by companies/individuals (Empresas). The system integrates with Bitrix24 for authentication and CRM sync, Supabase for database and auth, and ClickSign for e-signature workflows.

**Core Business Flow:**
1. Broker authenticates via Bitrix24 OAuth
2. Creates/manages Empresas (Companies/Individuals - PF or PJ)
3. Associates Imóveis (Properties) to Empresas
4. Generates sales authorization PDFs with contract terms
5. Sends documents to ClickSign for digital signature
6. Bidirectional sync with Bitrix24 CRM

## System Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                      USER (Broker/Admin)                        │
│                     via Bitrix24 iframe                         │
└────────────────────────────┬────────────────────────────────────┘
                             │
                    ┌────────▼─────────┐
                    │   Middleware     │  → Session validation
                    │  (Auth Guard)    │  → POST→GET redirect
                    │                  │  → iframe permissions
                    └────────┬─────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼───────┐   ┌────────▼────────┐  ┌───────▼────────┐
│  Next.js App  │   │   API Routes    │  │  Components    │
│    Routes     │   │  (Server-side)  │  │ (Client/Server)│
│               │   │                 │  │                │
│ /dashboard     │   │ /api/auth/*     │  │ Forms          │
│ /empresas      │   │ /api/empresas/* │  │ Lists          │
│ /imoveis       │   │ /api/imoveis/*  │  │ Cards          │
│ /autorizacoes  │   │ /api/bitrix/*   │  │ Selectors      │
│               │   │ /api/clicksign/*│  │ PDF Renderer   │
└───────┬───────┘   └────────┬────────┘  └───────┬────────┘
        │                    │                   │
        └────────────────────┼───────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼────────┐  ┌────────▼────────┐  ┌───────▼────────┐
│   Supabase     │  │   Bitrix24 API  │  │  ClickSign API │
│   Database     │  │   (CRM Sync)    │  │  (E-signature) │
│   + Auth       │  │                 │  │                │
│   + Storage    │  │ - OAuth         │  │ - Upload PDF   │
│   + RLS        │  │ - Company Sync  │  │ - Send to sign │
│                │  │ - Property SPA  │  │ - Webhooks     │
└────────────────┘  └─────────────────┘  └────────────────┘
```

## Core Components

### 1. Authentication Layer

#### **Bitrix24 OAuth Flow**
- **Purpose:** Authenticate users via Bitrix24
- **Location:** `app/api/auth/bitrix/`, `middleware.ts`
- **Flow:**
  1. User redirects to `/api/auth/bitrix/login`
  2. Redirects to Bitrix24 OAuth authorize page
  3. Bitrix24 callback to `/api/auth/bitrix/callback`
  4. Creates/updates user in `user_profiles` table
  5. Sets `beehouse_session` cookie with user data
  
#### **Session Middleware**
- **Purpose:** Protect routes and validate sessions
- **Location:** `middleware.ts`
- **Features:**
  - Session cookie validation (7-day expiry)
  - POST → GET redirect (Bitrix iframe compatibility)
  - CSP headers for iframe embedding
  - CORS for Bitrix24 domains
  - Public path exemptions

---

### 2. Data Layer (Supabase PostgreSQL)

#### **Database Schema**
- **Location:** `database/schema.sql`, `types/database.ts`

**Tables:**

| Table | Purpose | Key Relationships |
|-------|---------|-------------------|
| `user_profiles` | User accounts (extends auth.users) | FK to Supabase Auth |
| `empresas` | Companies/Individuals (PF/PJ) | FK to user_profiles |
| `imoveis` | Properties linked to companies | FK to empresas |
| `autorizacoes_vendas` | Sales authorizations | FK to imoveis |

**Row-Level Security (RLS):**
- Users can only access their own data
- Admins can access all data
- Policy enforcement at database level

**Key View:**
- `vw_autorizacoes_completas` - Denormalized view joining all tables for efficient queries

---

### 3. API Routes (Server-side)

#### **Auth APIs** (`app/api/auth/`)
- `bitrix/login/route.ts` - Initiate OAuth flow
- `bitrix/callback/route.ts` - Handle OAuth callback
- `check/route.ts` - Session validation endpoint
- `me/route.ts` - Get current user info

#### **Empresas APIs** (`app/api/empresas/`)
- `route.ts` - GET (list), POST (create)
- `[id]/route.ts` - GET (single), PUT (update), DELETE

#### **Imoveis APIs** (`app/api/imoveis/`)
- `route.ts` - GET (list by empresa_id), POST
- `[id]/route.ts` - GET, PUT, DELETE

#### **Autorizações APIs** (`app/api/autorizacoes/`)
- `route.ts` - GET (list), POST (create)
- `[id]/route.ts` - GET, PUT, DELETE
- `[id]/generate-pdf/route.ts` - Generate PDF from authorization
- `[id]/send-to-clicksign/route.ts` - Upload to ClickSign and request signature

#### **Bitrix24 Integration APIs** (`app/api/bitrix/`)
- `companies/route.ts` - Fetch companies from Bitrix24
- `properties/route.ts` - Fetch SPA items (properties)
- `my-authorizations/route.ts` - Sync user's authorizations
- `all-authorizations/route.ts` - Admin: all authorizations
- `user-info/route.ts` - Get current Bitrix user info
- `stats/route.ts` - Dashboard statistics
- `cadastro-autorizacao/route.ts` - Create authorization in Bitrix SPA

#### **PDF Generation** (`app/api/pdf/`)
- `generate/route.ts` - Generate PDF (legacy)
- `generate-authorization/route.ts` - Generate authorization PDF with React-PDF

#### **ClickSign Integration** (`app/api/clicksign/`)
- `webhook/route.ts` - Handle ClickSign webhook events (signature completed, etc.)

**Common Patterns:**
- Zod validation for all inputs
- Consistent error handling with `NextResponse`
- Service role key for admin operations
- User-scoped queries via RLS

---

### 4. Frontend Components

#### **App Routes** (`app/`)
| Route | Purpose |
|-------|---------|
| `/dashboard` | Main dashboard with stats |
| `/empresas` | List companies/individuals |
| `/nova-empresa` | Create new company |
| `/editar-empresa/[id]` | Edit company |
| `/imoveis` | List properties |
| `/novo-imovel` | Create new property |
| `/editar-imovel/[id]` | Edit property |
| `/minhas-autorizacoes` | List my authorizations |
| `/nova-autorizacao` | Create authorization |
| `/editar-autorizacao/[id]` | Edit authorization |
| `/login` | Login/OAuth page |
| `/install` | Bitrix24 app installation |

#### **Component Structure** (`components/`)

**Cards** (`cards/`)
- `EmpresaCard.tsx` - Display company summary
- `ImovelCard.tsx` - Display property summary

**Dashboard** (`dashboard/`)
- `AuthorizationList.tsx` - Server component list
- `CompanyList.tsx` - Server component list
- `PropertyList.tsx` - Server component list

**Forms** (`forms/`)
- `EmpresaForm.tsx` - PF/PJ company form
- `ImovelForm.tsx` - Property creation form
- `Input.tsx`, `Select.tsx`, `Textarea.tsx` - Reusable form inputs
- `MaskedInput.tsx` - CPF/CNPJ/Phone formatting
- `CompanySection.tsx`, `SpouseSection.tsx`, `SocioFields.tsx` - Form sections
- `PropertyFinancialFields.tsx` - Financial inputs

**Lists** (`lists/`)
- `AutorizacoesList.tsx` - Client component with search/filter
- `EmpresasList.tsx` - Client component with search/filter
- `ImoveisList.tsx` - Client component with search/filter

**Selectors** (`selectors/`)
- `EmpresaSelector.tsx` - Dropdown for selecting company
- `ImovelSelector.tsx` - Dropdown for selecting property

**PDF** (`pdf/`)
- `AuthorizationPDF.tsx` - React-PDF template for sales authorization

**UI Components** (`ui/`)
- `Badge.tsx`, `Button.tsx`, `Dropdown.tsx`
- `EmptyState.tsx`, `LoadingSpinner.tsx`, `Skeleton.tsx`
- `StatsCard.tsx`, `TabNavigation.tsx`

**Layout** (`layout/`)
- `Navbar.tsx` - Main navigation with user context

---

### 5. Business Logic Layer (`lib/`)

#### **Authentication** (`lib/auth/`)
- `auth.ts` - Session management utilities

#### **Bitrix24 Integration** (`lib/bitrix/`)
- `client.ts` - Bitrix24 REST API client
- `sync.ts` - Bidirectional sync logic
- `oauth.ts` - OAuth token management
- `types.ts` - Bitrix24 API types

#### **ClickSign Integration** (`lib/clicksign/`)
- `client.ts` - ClickSign API client

#### **Supabase** (`lib/supabase/`)
- `client.ts` - Browser client (anon key)
- `server.ts` - Server client (service role)
- `middleware.ts` - Middleware client
- `storage.ts` - File upload utilities

#### **PDF Generation** (`lib/pdf/`)
- `generator.ts` - PDF template logic
- `types.ts` - PDF data types
- `formatter.ts` - Data formatting utilities

#### **Validation** (`lib/validations/`)
- `empresa.ts` - Zod schemas for companies
- `imovel.ts` - Zod schemas for properties
- `autorizacao.ts` - Zod schemas for authorizations

#### **Utilities** (`lib/utils/`)
- `formatters.ts` - Currency, date, CPF/CNPJ formatters
- `currency.ts`, `date.ts`, `cpf-cnpj.ts`, `phone.ts`, `cep.ts`
- Toast notifications (`lib/toast.ts`)

#### **Cache** (`lib/cache/`)
- `kv.ts` - Vercel KV cache client (optional)

---

## Data Flow

### Creating a Sales Authorization

1. **User selects/creates Empresa**
   - Frontend: `/empresas` → `EmpresaForm`
   - API: `POST /api/empresas`
   - Database: INSERT into `empresas` table
   - Optional: Sync to Bitrix24 Companies

2. **User creates Imóvel for Empresa**
   - Frontend: `/novo-imovel` → `ImovelForm` with `EmpresaSelector`
   - API: `POST /api/imoveis`
   - Database: INSERT into `imoveis` table
   - Optional: Sync to Bitrix24 SPA "Imóveis"

3. **User creates Autorização for Imóvel**
   - Frontend: `/nova-autorizacao` → Form with `ImovelSelector`
   - API: `POST /api/autorizacoes`
   - Database: INSERT into `autorizacoes_vendas` with status='rascunho'

4. **Generate PDF**
   - API: `POST /api/autorizacoes/[id]/generate-pdf`
   - Uses `@react-pdf/renderer` to create PDF
   - Uploads to Supabase Storage
   - Updates `pdf_url` and `pdf_filename` in database

5. **Send to ClickSign**
   - API: `POST /api/autorizacoes/[id]/send-to-clicksign`
   - Uploads PDF to ClickSign
   - Creates signature request for client
   - Updates status to 'aguardando_assinatura'
   - Stores `clicksign_document_key`

6. **ClickSign Webhook (async)**
   - Webhook: `POST /api/clicksign/webhook`
   - Updates status to 'assinado' when signed
   - Sets `signed_at` timestamp

7. **Sync to Bitrix24**
   - API: `POST /api/bitrix/cadastro-autorizacao`
   - Creates item in Bitrix24 SPA
   - Attaches PDF link as custom field

---

## Integration Points

| Service | Type | Purpose | Authentication |
|---------|------|---------|----------------|
| **Supabase** | Database + Auth + Storage | Primary data store, file storage | Service Role Key + Anon Key |
| **Bitrix24** | CRM + OAuth | User auth, company/property sync | OAuth 2.0 + Webhooks |
| **ClickSign** | E-signature | Digital signature workflow | API Token |
| **Vercel** | Hosting | Next.js deployment | N/A |
| **Vercel KV** | Cache (optional) | Performance optimization | API Tokens |

---

## Conventions

### Naming
- **Files:** camelCase for components (`EmpresaCard.tsx`), kebab-case for routes (`nova-empresa/`)
- **Database:** snake_case (`created_by_user_id`)
- **TypeScript:** PascalCase for types/interfaces (`AutorizacaoCompleta`)
- **Functions:** camelCase (`createEmpresa`)

### Structure
- **App Router:** File-based routing in `app/`
- **Colocation:** Components next to routes when route-specific
- **Shared components:** `components/` directory
- **Business logic:** `lib/` directory
- **Types:** `types/` directory with domain separation

### Testing
- **Current state:** No automated tests present
- **Testing approach:** Manual testing via UI
- **Verification:** Browser testing in Bitrix24 iframe

### Error Handling
- **API:** NextResponse with status codes + JSON errors
- **Frontend:** react-hot-toast for user notifications
- **Validation:** Zod schemas at API boundaries
- **Database:** RLS policies for data isolation

### State Management
- **Forms:** React Hook Form + Zod
- **Server state:** Server Components (no client state management library)
- **Session:** HTTP-only cookies

---

## Technical Debt

### High Priority
- [ ] **No automated tests** - No unit, integration, or E2E tests present (Location: entire codebase)
- [ ] **Missing error boundaries** - No React error boundaries to catch component failures (Location: `app/layout.tsx`, page components)
- [ ] **No centralized error logging** - Console.log only, no Sentry/monitoring (Location: API routes, middleware)

### Medium Priority
- [ ] **Inconsistent validation** - Some API routes lack Zod validation (Location: verify all API routes)
- [ ] **Mixed auth patterns** - Bitrix OAuth + custom session cookies instead of Supabase Auth only (Location: `middleware.ts`, auth APIs)
- [ ] **No TypeScript strict mode** - `tsconfig.json` doesn't enforce strict mode (Location: `tsconfig.json`)
- [ ] **Duplicate PDF generation endpoints** - `/api/pdf/generate` and `/api/pdf/generate-authorization` (Location: `app/api/pdf/`)

### Low Priority
- [ ] **Console statements in production** - Debug console.logs present in middleware (Location: `middleware.ts:28-42`)
- [ ] **Unused config file** - `next.config.js` exists alongside `next.config.mjs` (Location: root directory)
- [ ] **No API rate limiting** - Public API routes unprotected (Location: all API routes)
- [ ] **Missing SEO metadata** - Most pages lack proper meta tags (Location: page components)

---

## Security Considerations

### Implemented
✅ Row-Level Security (RLS) on all tables  
✅ Supabase service role key protected (server-only)  
✅ Session cookie validation  
✅ Input validation with Zod schemas  
✅ CORS restricted to Bitrix24 domains  

### Needs Review
⚠️ Custom session management instead of Supabase Auth sessions  
⚠️ No CSRF protection on state-changing operations  
⚠️ ClickSign webhook lacks signature verification  
⚠️ API routes accessible without rate limiting  

---

## Performance Optimizations

### Active
- React Server Components by default (minimal JS shipped)
- Package import optimization (`@supabase/supabase-js`, `@supabase/ssr`)
- Static asset caching (31536000s for `_next/static`)
- API response caching (60s max-age, 120s stale-while-revalidate)
- Compression enabled
- AVIF/WebP image formats supported

### Potential Improvements
- [ ] Implement Vercel KV for API response caching
- [ ] Add database query optimization (missing indexes on common queries)
- [ ] Implement React.lazy() for modal components
- [ ] Optimize Bitrix24 API calls with batching
- [ ] Add Suspense boundaries for better streaming

---

## Deployment

**Platform:** Vercel  
**Framework:** Next.js 14 (App Router)  
**Build command:** `npm run build`  
**Environment variables:** See `.env.example`  

**Critical env vars:**
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `B24_CLIENT_ID`, `B24_CLIENT_SECRET`
- `CLICKSIGN_API_TOKEN`

**Post-deployment:**
1. Run database migrations in Supabase SQL Editor
2. Set up Bitrix24 app with callback URLs
3. Configure ClickSign webhooks
4. Test in Bitrix24 iframe
