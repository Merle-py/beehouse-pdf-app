# Technology Stack

> Generated by /map on 2026-01-19

## Runtime

| Technology | Version | Purpose |
|------------|---------|---------|
| Node.js | 20.x (LTS) | Server runtime |
| Next.js | 14.1.0 | React framework (App Router) |
| React | 18.2.0 | UI library |
| TypeScript | 5.3.3 | Type safety |
| PostgreSQL | 14+ | Database (via Supabase) |

---

## Production Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| **next** | ^14.1.0 | App Router framework, SSR, API routes |
| **react** | ^18.2.0 | Component library |
| **react-dom** | ^18.2.0 | DOM rendering |
| **@supabase/supabase-js** | ^2.90.1 | Supabase client SDK |
| **@supabase/ssr** | ^0.8.0 | Server-side Supabase utilities |
| **@supabase/auth-helpers-nextjs** | ^0.15.0 | Next.js auth integration (deprecated?) |
| **@react-pdf/renderer** | ^4.2.0 | Server-side PDF generation |
| **react-hook-form** | ^7.50.1 | Form state management |
| **@hookform/resolvers** | ^3.3.4 | Zod integration for forms |
| **zod** | ^3.22.4 | Schema validation |
| **react-hot-toast** | ^2.6.0 | Toast notifications |
| **axios** | ^1.6.8 | HTTP client for external APIs |
| **@vercel/kv** | ^1.0.1 | Vercel KV cache (optional) |

---

## Development Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| **typescript** | ^5.3.3 | TypeScript compiler |
| **@types/node** | ^20.11.16 | Node.js type definitions |
| **@types/react** | ^18.2.55 | React type definitions |
| **@types/react-dom** | ^18.2.19 | React DOM type definitions |
| **tailwindcss** | ^3.4.1 | Utility-first CSS framework |
| **postcss** | ^8.4.35 | CSS processor |
| **autoprefixer** | ^10.4.17 | CSS vendor prefix automation |

---

## Infrastructure

| Service | Provider | Purpose | Configuration |
|---------|----------|---------|---------------|
| **Database** | Supabase (PostgreSQL 14) | Primary data store | 4 tables + RLS policies |
| **Authentication** | Bitrix24 OAuth 2.0 | User authentication | Client ID/Secret |
| **File Storage** | Supabase Storage | PDF file hosting | Public bucket for PDFs |
| **Hosting** | Vercel | Next.js deployment | Auto-deploy from git |
| **CDN** | Vercel Edge Network | Static assets + edge middleware | Automatic |
| **E-signature** | ClickSign | Digital signature workflow | API token auth |
| **CRM Integration** | Bitrix24 REST API | Company/property sync | Webhook URL for admin ops |
| **Cache** | Vercel KV (optional) | API response caching | Redis-compatible |

---

## External APIs

### Supabase
- **Base URL:** `https://rkgypggegjhkdidvvnya.supabase.co`
- **Auth:** Anon Key (public) + Service Role Key (server)
- **Usage:**
  - Database queries (RLS-protected)
  - File uploads to Storage
  - User authentication (extended with Bitrix24)

### Bitrix24
- **Auth:** OAuth 2.0 + REST API webhooks
- **Endpoints used:**
  - `crm.company.list` - Fetch companies
  - `crm.item.list` - Fetch SPA items (properties)
  - `crm.item.add` - Create SPA items
  - `user.current` - Get user info
- **Custom fields:**
  - `UF_CRM_1736895841` - "Has authorization" flag
  - `UF_CRM_1736895862` - Authorization file link

### ClickSign
- **Base URL:** `https://app.clicksign.com/api/v3/`
- **Auth:** Bearer token
- **Endpoints used:**
  - `POST /documents` - Upload PDF
  - `POST /documents/:key/signer_requests` - Request signature
  - `GET /documents/:key` - Check status
- **Webhooks:** `POST /api/clicksign/webhook` - Status updates

---

## Configuration

### Environment Variables

| Variable | Purpose | Required | Default |
|----------|---------|----------|---------|
| **NEXT_PUBLIC_SUPABASE_URL** | Supabase project URL | ✅ Yes | N/A |
| **NEXT_PUBLIC_SUPABASE_ANON_KEY** | Public anon key | ✅ Yes | N/A |
| **SUPABASE_SERVICE_ROLE_KEY** | Admin key (server-only) | ✅ Yes | N/A |
| **B24_CLIENT_ID** | Bitrix24 OAuth client | ✅ Yes | N/A |
| **B24_CLIENT_SECRET** | Bitrix24 OAuth secret | ✅ Yes | N/A |
| **B24_ADMIN_WEBHOOK_URL** | Admin webhook for sync | ✅ Yes | N/A |
| **B24_PROPERTY_ENTITY_TYPE_ID** | SPA entity ID for properties | ✅ Yes | N/A |
| **B24_ADMIN_IDS** | Comma-separated admin IDs | ✅ Yes | N/A |
| **B24_PROPERTY_HAS_AUTHORIZATION_FIELD** | Custom field ID | ✅ Yes | N/A |
| **B24_PROPERTY_AUTHORIZATION_FILE_FIELD** | Custom field ID | ✅ Yes | N/A |
| **CLICKSIGN_API_TOKEN** | ClickSign API token | ✅ Yes | N/A |
| **CLICKSIGN_WEBHOOK_SECRET** | Webhook signature key | ⚠️ Optional | N/A |
| **BEEHOUSE_SIGNER_NAME** | Company signer name | ✅ Yes | N/A |
| **BEEHOUSE_SIGNER_EMAIL** | Company signer email | ✅ Yes | N/A |
| **BEEHOUSE_SIGNER_CPF** | Company signer CPF | ✅ Yes | N/A |
| **NEXT_PUBLIC_APP_URL** | App base URL | ✅ Yes | http://localhost:3000 |
| **NODE_ENV** | Environment | ✅ Yes | development |
| **DEV_BYPASS_AUTH** | Skip auth in dev | ⚠️ Optional | false |
| **KV_URL** | Vercel KV URL | ⚠️ Optional | N/A |
| **KV_REST_API_URL** | Vercel KV REST | ⚠️ Optional | N/A |
| **KV_REST_API_TOKEN** | Vercel KV token | ⚠️ Optional | N/A |
| **KV_REST_API_READ_ONLY_TOKEN** | Vercel KV read token | ⚠️ Optional | N/A |

---

## Build Configuration

### Next.js Config (`next.config.mjs`)
```javascript
{
  experimental: {
    optimizePackageImports: ['@supabase/supabase-js', '@supabase/ssr']
  },
  poweredByHeader: false,
  compress: true,
  images: {
    domains: ['cdn.bitrix24.com.br'],
    formats: ['image/avif', 'image/webp']
  }
}
```

### TypeScript Config (`tsconfig.json`)
- Target: ES5
- Module: ESNext
- JSX: preserve
- Strict: **false** ⚠️ (technical debt)
- Incremental: true
- Paths: `@/*` → `./`

### Tailwind Config (`tailwind.config.ts`)
- Content paths: `./app/**/*.{js,ts,jsx,tsx}`, `./components/**/*.{js,ts,jsx,tsx}`
- Theme extensions: None (using defaults)

### PostCSS Config (`postcss.config.js`)
```javascript
{
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
}
```

---

## Database Schema

### Tables
1. **user_profiles** (4 columns, 3 indexes)
2. **empresas** (27 columns, 5 indexes)
3. **imoveis** (12 columns, 3 indexes)
4. **autorizacoes_vendas** (15 columns, 4 indexes)

### Triggers
- `update_updated_at_column()` on all tables

### Views
- `vw_autorizacoes_completas` (denormalized join)

### Storage Buckets
- `beehouse-pdfs` (public) - PDF authorizations

---

## Security & Performance

### Implemented Security
- ✅ Row-Level Security (RLS) on all tables
- ✅ Supabase service role key isolation (server-only)
- ✅ Input validation (Zod schemas)
- ✅ CORS limited to Bitrix24 domains
- ✅ CSP headers for iframe embedding
- ✅ Session cookie HTTP-only

### Performance Features
- ✅ Server Components by default
- ✅ Optimized package imports
- ✅ Static asset caching (1 year)
- ✅ API response caching (60s + SWR)
- ✅ Compression enabled
- ✅ Modern image formats (AVIF/WebP)

---

## Package Vulnerabilities

**Status:** ✅ No known high/critical vulnerabilities (as of mapping date)

**Outdated packages:** None critical
- Most packages are recent versions
- Next.js 14 is current major version
- React 18 is stable

**Recommendations:**
- [ ] Regularly run `npm audit`
- [ ] Consider enabling Dependabot for automated updates
- [ ] Monitor Supabase client updates for auth improvements

---

## Scripts

| Script | Command | Purpose |
|--------|---------|---------|
| `dev` | `next dev` | Start development server (port 3000) |
| `build` | `next build` | Production build |
| `start` | `next start` | Start production server |
| `lint` | `next lint` | Run ESLint |

**Missing scripts:**
- No `test` script (no testing setup)
- No `typecheck` script (no standalone TypeScript check)
- No database migration runner

---

## Browser Compatibility

**Target:** Modern browsers (ES6+)
- Chrome/Edge 90+
- Firefox 88+
- Safari 14+

**Notes:**
- Embedded in Bitrix24 iframe (must support iframe embedding)
- No IE11 support required
- Next.js handles polyfills automatically

---

## Development Tools

### Recommended IDE
- **VS Code** with extensions:
  - ESLint
  - Prettier
  - Tailwind CSS IntelliSense
  - TypeScript Vue Plugin (for TSX)

### Database Tools
- **Supabase Dashboard** - SQL editor, table browser
- **pgAdmin** / **TablePlus** - Local PostgreSQL clients

### API Testing
- **Postman** / **Insomnia** - REST API testing
- **Bitrix24 API Console** - Test Bitrix endpoints
- **ClickSign Dashboard** - Monitor signature status

---

## Deployment

### Vercel Configuration (`vercel.json`)
```json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "headers": [
    // CORS and CSP headers for all routes
  ]
}
```

### Build Process
1. Install dependencies (`npm install`)
2. Run Next.js build (`npm run build`)
3. Output: `.next` directory
4. Vercel deployment automatic on push

### Post-Deployment Checklist
- [ ] Run database migrations in Supabase
- [ ] Configure Bitrix24 app URLs
- [ ] Set ClickSign webhook URL
- [ ] Test OAuth flow in production
- [ ] Verify RLS policies
- [ ] Test PDF generation
- [ ] Verify ClickSign integration

---

## Monitoring & Observability

**Current state:** ⚠️ **Minimal monitoring**

**Available:**
- Console logs (development only)
- Vercel Analytics (basic traffic metrics)
- Supabase Dashboard (query performance)

**Missing:**
- Error tracking (Sentry, Bugsnag)
- Performance monitoring (no APM)
- User analytics (no product analytics)
- Uptime monitoring

**Recommendations:**
- [ ] Add Sentry for error tracking
- [ ] Enable Vercel Web Analytics
- [ ] Set up Supabase logging
- [ ] Add custom metrics to Vercel KV
